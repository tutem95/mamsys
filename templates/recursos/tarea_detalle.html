{% extends "base.html" %}
{% block title %}{{ tarea.nombre }} · Presupuesto{% endblock %}

{% block content %}
<main class="shell">
    {% include "recursos/includes/lote_nav_tabs.html" %}
    <header>
        <div>
            <h1>{{ tarea.nombre }}</h1>
            <p>Lote: {{ lote.nombre }} · Rubro: {{ tarea.rubro }} · Subrubro: {{ tarea.subrubro }}</p>
            <a class="link link-back" href="{% url 'recursos:tarea_list' lote.pk %}">← Volver a tareas</a>
        </div>
        <a href="{% url 'recursos:tarea_edit' lote.pk tarea.pk %}" class="btn-link">Editar</a>
        <a href="{% url 'recursos:tarea_recurso_add' lote.pk tarea.pk %}" class="btn btn-primary">+ Agregar recurso</a>
    </header>

    <section class="card">
        <h2 style="margin:0 0 12px;">Recursos de la tarea</h2>
        {% if recursos %}
        <table>
            <thead>
            <tr>
                <th>#</th>
                <th>Tipo</th>
                <th>Recurso</th>
                <th>Proveedor / Unidad</th>
                <th class="num">Cantidad</th>
                <th class="num">Precio análisis</th>
                <th class="num">Subtotal</th>
                {% if lote.tipo_dolar and lote.fecha_dolar %}<th class="num">UA en USD</th>{% endif %}
                <th></th>
            </tr>
            </thead>
            <tbody>
            {% for rec in recursos %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>
                    {% if rec.material %}Material{% elif rec.mano_de_obra %}Mano de obra{% elif rec.subcontrato %}Subcontrato{% elif rec.mezcla %}Mezcla{% endif %}
                </td>
                <td>
                    {% if rec.material %}{{ rec.material }}{% endif %}
                    {% if rec.mano_de_obra %}{{ rec.mano_de_obra.tarea }}{% endif %}
                    {% if rec.subcontrato %}{{ rec.subcontrato.tarea }}{% endif %}
                    {% if rec.mezcla %}{{ rec.mezcla.nombre }}{% endif %}
                </td>
                <td>
                    {% if rec.material %}{{ rec.material.proveedor|default:"-" }}{% endif %}
                    {% if rec.mano_de_obra %}{{ rec.mano_de_obra.equipo.nombre }} / {{ rec.mano_de_obra.ref_equipo.nombre }}{% endif %}
                    {% if rec.subcontrato %}{{ rec.subcontrato.proveedor|default:"-" }}{% endif %}
                    {% if rec.mezcla %}{{ rec.mezcla.unidad_de_mezcla }}{% endif %}
                </td>
                <td class="num">{{ rec.cantidad|floatformat:2 }}</td>
                <td class="num">{{ rec.precio_unitario|floatformat:2 }}</td>
                <td class="num">{{ rec.costo_total|floatformat:2 }}</td>
                {% if lote.tipo_dolar and lote.fecha_dolar %}
                <td class="num">{% if rec.costo_total_usd is not None %}{{ rec.costo_total_usd|floatformat:2 }}{% else %}-{% endif %}</td>
                {% endif %}
                <td>
                    <form action="{% url 'recursos:tarea_recurso_delete' lote.pk tarea.pk rec.pk %}" method="post" style="display:inline">
                        {% csrf_token %}
                        <button type="submit" class="btn-link btn-danger" onclick="return confirm('¿Quitar este recurso?');">Quitar</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
            </tbody>
            <tfoot>
            <tr style="font-weight:600; border-top:2px solid var(--border);">
                <td colspan="6" style="text-align:right;">Total:</td>
                <td class="num">{{ total|floatformat:2 }}</td>
                {% if lote.tipo_dolar and lote.fecha_dolar %}
                <td class="num">{% if total_usd is not None %}USD {{ total_usd|floatformat:2 }}{% else %}-{% endif %}</td>
                {% endif %}
                <td></td>
            </tr>
            </tfoot>
        </table>
        {% else %}
        <p style="font-size:0.9rem; color:var(--text-muted);">Esta tarea no tiene recursos. Agregá materiales, mano de obra, subcontratos o mezclas.</p>
        {% endif %}
    </section>
</main>
{% endblock %}
